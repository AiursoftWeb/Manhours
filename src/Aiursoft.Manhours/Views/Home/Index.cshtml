<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Man-hours markdown link generator</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>

<main role="main" class="container">
    <form method="post" class="mt-5">
        <div class="form-group">
            <label for="git">Git Server Type</label>
            <select class="form-control" id="git" name="git">
                <option value="gitlab">GitLab</option>
                <option value="github">GitHub</option>
            </select>
        </div>
        
        <div class="form-group mt-3">
            <label for="cloneUrl">HTTP Clone URL</label>
            <input type="text" class="form-control" id="cloneUrl" name="cloneUrl" placeholder="https://gitlab.aiursoft.cn/aiursoft/Manhours.git">
        </div>
        
        <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" value="" id="directMode" name="directMode">
            <label class="form-check-label" for="directMode">
                Direct mode (Without proxy from img.shields.io)
            </label>
        </div>
        
        <button type="submit" class="btn btn-primary mt-3">Generate</button>

        <div class="mt-3 hidden" id="result">
            <label for="preview">Preview</label>
            <div class="form-group" id="preview">
                <img alt="Man hours icon" id="preview-img" src="https://img.shields.io/endpoint?url=https%3A%2F%2Fmanhours.aiursoft.cn%2Fgitlab%2Fgitlab.aiursoft.cn%2Faiursoft%2Fmanhours.json" />
            </div>
            
            <label for="markdown" class="mt-3">Markdown</label>
            <textarea class="form-control" rows="3" readonly></textarea>

            <label for="html" class="mt-3">HTML</label>
            <textarea class="form-control" rows="3" readonly></textarea>
        </div>
    </form>
</main>

<footer class="footer">
    <div class="container">
        <span class="text-muted">Man-hours, a project to know how much time you have spent on your project.</span>
        <a href="https://gitlab.aiursoft.cn/aiursoft/Manhours" class="text-muted">Source code</a>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function () {
        $("form").submit(function (e) {
            e.preventDefault();
            
            // Prepare
            const result = $("#result");
            const previewImg = result.find("#preview-img");            
            const markdown = result.find("textarea").eq(0);
            const html = result.find("textarea").eq(1);
            
            // Get Input
            const gitServerType = $("#git").val();
            const directMode = $("#directMode").is(":checked");
            let cloneUrl = $("#cloneUrl").val();
            // Clean up
            result.addClass("hidden");
            
            // Check
            if (!cloneUrl) {
                alert("Please input the clone url!");
                return;
            }
            
            // if clone Url ends with .git, remove it.
            if (cloneUrl.endsWith(".git")) {
                cloneUrl = cloneUrl.substring(0, cloneUrl.length - 4);
            }
            
            if (cloneUrl.startsWith("https://")) {
                cloneUrl = cloneUrl.substring(8);
            }
            
            let imgLink;
            if (directMode) {
                cloneUrl += ".svg";
                imgLink = "@(Context.Request.Scheme)://@(Context.Request.Host)/" + gitServerType + "/" + cloneUrl;
            } else {
                cloneUrl += ".json";
                cloneUrl = encodeURIComponent(cloneUrl);
                imgLink = "https://img.shields.io/endpoint?url=@(Context.Request.Scheme)%3A%2F%2F@(Context.Request.Host)%2F" + gitServerType + "%2F" + cloneUrl;
            }

            const markdownVal = "![Man hours](" + imgLink + ")";
            const htmlVal = "<img alt=\"Man hours\" src=\"" + imgLink + "\" />";
            
            previewImg.attr("src", imgLink);
            markdown.val(markdownVal);
            html.val(htmlVal);
            
            // Show result
            result.removeClass("hidden");
        });
    });
</script>
</body>
</html>