<style>
    .hidden {
        display: none;
    }
</style>

<div class="container py-4">
    <h1 class="h3 mb-3">Manhours</h1>

    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Badge Generator</h5>
                    <small class="text-muted d-block">
                        Enter the clone url of your git repository to generate a badge for your project.
                    </small>
                </div>
                <div class="card-body">
                    <form method="post" id="manhours-form">
                        <div class="mb-3">
                            <label for="cloneUrl" class="form-label">
                                <i class="fa-brands fa-git-alt"></i>
                                HTTP Clone URL
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="cloneUrl"
                                   name="cloneUrl"
                                   placeholder="https://gitlab.aiursoft.com/aiursoft/manhours.git" />
                        </div>

                        <div class="form-check mt-2">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="directMode"
                                   name="directMode" />
                            <label class="form-check-label" for="directMode">
                                Direct mode (Without proxy from img.shields.io)
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">Generate</button>

                        <div class="mt-4 hidden" id="result">
                            <label for="preview" class="form-label">Preview</label>
                            <div class="mb-3" id="preview">
                                <i class="fas fa-spinner fa-spin hidden" id="loading-icon"></i>
                                <img alt="Man hours icon"
                                     id="preview-img"
                                     class="img-fluid"
                                     src="https://img.shields.io/endpoint?url=https%3A%2F%2Fmanhours.aiursoft.com%2Fgitlab%2Fgitlab.aiursoft.com%2Faiursoft%2Fmanhours.json" />
                            </div>

                            <label for="markdown" class="form-label mt-2">Markdown</label>
                            <textarea id="markdown" class="form-control" rows="3" readonly></textarea>

                            <label for="html" class="form-label mt-3">HTML</label>
                            <textarea id="html" class="form-control" rows="3" readonly></textarea>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("manhours-form");

            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const markdown = document.getElementById("markdown");
                const html = document.getElementById("html");
                const result = document.getElementById("result");
                const previewImg = result.querySelector("#preview-img");

                // Hide result while generating
                result.classList.add("hidden");
                previewImg.src = "";

                // Read user input
                const directMode = document.getElementById("directMode").checked;
                let cloneUrl = document.getElementById("cloneUrl").value.trim();

                if (!cloneUrl) {
                    alert("Please input the clone url!");
                    return;
                }

                // Normalize URL
                if (cloneUrl.endsWith(".git")) {
                    cloneUrl = cloneUrl.substring(0, cloneUrl.length - 4);
                }
                if (cloneUrl.startsWith("https://")) {
                    cloneUrl = cloneUrl.substring(8);
                }

                let imgLink;
                if (directMode) {
                    cloneUrl += ".svg";
                    imgLink = "@(Context.Request.Scheme)://@(Context.Request.Host)/" + "r/" + cloneUrl;
                } else {
                    cloneUrl += ".json";
                    cloneUrl = encodeURIComponent(cloneUrl);
                    imgLink = "https://img.shields.io/endpoint?url=@(Context.Request.Scheme)%3A%2F%2F@(Context.Request.Host)%2F" + "r" + "%2F" + cloneUrl;
                }

                const markdownVal = "![Man hours](" + imgLink + ")";
                const htmlVal = "<img alt=\"Man hours\" src=\"" + imgLink + "\" />";
                markdown.value = markdownVal;
                html.value = htmlVal;

                // Handle preview
                const loadingIcon = result.querySelector("#loading-icon");
                loadingIcon.classList.remove("hidden");
                previewImg.classList.add("hidden");
                previewImg.src = imgLink;
                previewImg.onload = function () {
                    loadingIcon.classList.add("hidden");
                    previewImg.classList.remove("hidden");
                };

                // Show result
                result.classList.remove("hidden");
            });
        });
    </script>
}
